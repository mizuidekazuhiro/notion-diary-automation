name: Daily Notion Diary - Scheduler

on:
  schedule:
    - cron: "0 16 * * *"
    - cron: "0 22 * * *"
  workflow_dispatch:
    inputs:
      phase:
        description: "Phase to dispatch"
        required: true
        default: ingest
        type: choice
        options:
          - ingest
          - publish

jobs:
  dispatch-phase:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Determine phase
        id: phase
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            case "${{ github.event.schedule }}" in
              "0 16 * * *")
                echo "phase=ingest" >> "$GITHUB_OUTPUT"
                ;;
              "0 22 * * *")
                echo "phase=publish" >> "$GITHUB_OUTPUT"
                ;;
              *)
                echo "Unknown schedule: ${{ github.event.schedule }}"
                exit 1
                ;;
            esac
          else
            echo "phase=${{ inputs.phase }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Dispatch workflow
        uses: actions/github-script@v7
        env:
          PHASE: ${{ steps.phase.outputs.phase }}
        with:
          script: |
            const phase = process.env.PHASE;
            const workflow = phase === 'ingest'
              ? 'ingest_daily_log.yml'
              : 'publish_daily_mail.yml';
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow,
              ref: context.ref
            });
